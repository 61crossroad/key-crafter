<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.keycrafter.mapper.ProductMapper">
	<resultMap type="kr.co.keycrafter.domain.ProductVO" id="productMap">
		<result property="pid" column="pid"/>
		<result property="pName" column="pname"/>
		<result property="price" column="price"/>
		<result property="quantity" column="quantity"/>
		<result property="productDesc" column="productdesc"/>
		<result property="company" column="company"/>
		<result property="madeIn" column="madein"/>
		<result property="regDate" column="regdate"/>
		<result property="updateDate" column="updatedate"/>
		<collection property="attachList" resultMap="attachMap"/>
		<collection property="categoryList" resultMap="categoryMap"/>
	</resultMap>
	
	<resultMap type="kr.co.keycrafter.domain.ProductAttachVO" id="attachMap">
		<result property="uuid" column="uuid"/>
		<result property="uploadPath" column="uploadpath"/>
		<result property="fileName" column="filename"/>
		<result property="pid" column="pid"/>
		<result property="mainImage" column="mainimage"/>
	</resultMap>
	
	<resultMap type="kr.co.keycrafter.domain.CategoryVO" id="categoryMap">
		<result property="catNum" column="catnum"/>
		<result property="catName" column="catname"/>
	</resultMap>
	
	<insert id="insertProduct">
		INSERT INTO product
		(pid, pname, price, quantity, productdesc, company, madein)
		VALUES
		(seq_product.nextval, #{pName}, #{price}, #{quantity}, #{productDesc}, #{company}, #{madeIn})
	</insert>
	
	<insert id="insertSelectKeyProduct">
		<selectKey keyProperty="pid" order="BEFORE" resultType="int">
			SELECT seq_product.nextval from dual
		</selectKey>
		INSERT INTO product
		(pid, pname, price, quantity, productdesc, company, madein)
		VALUES
		(#{pid}, #{pName}, #{price}, #{quantity}, #{productDesc}, #{company}, #{madeIn})
	</insert>
	
	<insert id="insertCategoryToProduct">
		INSERT INTO product_category
		(pid, catnum)
		VALUES
		(#{pid}, #{catNum})
	</insert>
	
	<select id="getProduct" resultMap="productMap">
		SELECT p.pid, p.pname, p.price, p.quantity, p.productDesc, p.company, p.madein,
			a.uuid, a.uploadpath, a.filename, c.catnum, c.catname
		FROM product p
		LEFT OUTER JOIN product_attach a
		ON p.pid = a.pid
		LEFT OUTER JOIN product_category pc
		ON p.pid = pc.pid
			LEFT OUTER JOIN category c
			ON pc.catnum = c.catnum
		WHERE p.pid = #{pid}
	</select>
	
	<select id="getProductList" resultMap="productMap">
	<!--
		<![CDATA[
			SELECT pid, pname, price FROM product WHERE pid > 0
		]]>
	-->
		SELECT p.pid, p.pname, p.price, a.uuid, a.uploadpath, a.filename, c.catnum
		FROM product p
		LEFT OUTER JOIN product_attach a
		ON p.pid = a.pid AND a.mainimage = 'T'
		LEFT OUTER JOIN product_category pc
		ON p.pid = pc.pid
			LEFT OUTER JOIN category c
			ON pc.catnum = c.catnum
		ORDER BY p.pid DESC
	</select>
	
	<update id="updateProduct">
		UPDATE product
		SET pname = #{pName}, price = #{price}, quantity = #{quantity}, productdesc = #{productDesc}, company = #{company}, madein = #{madeIn}, updatedate = sysdate
		WHERE pid = #{pid}
	</update>
	
	<delete id="deleteCategoryFromProduct">
		DELETE FROM product_category
		WHERE pid = #{pid}
	</delete>
	
	<delete id="deleteProduct">
		DELETE FROM product
		WHERE pid = #{pid}
	</delete>
	
	
</mapper>